{% extends 'frontend/base.html' %}
{% load static %}

{% block extrahead %}
<script type="text/javascript">
var ranking_budgets = [];
var ranking_average = {};
function get_ranking(callback) {
    var url = '/api/budgets/ranking/';
    $.get(url, function (data) {
        ranking_budgets = data['budgets'];
        ranking_average = data['average'];
        callback(data);
    }).fail(function () {
        console.log("Error on fetching ranking data.");
    });
}
function plot_ranking(){
    var data = {'budgets': ranking_budgets, 'average': ranking_average};
    renderTemplate('#template-ranking', data, '.ranking-wrapper .budgets-wrapper');
}
function sort_ranking(dimension){
    ranking_budgets = sortByKey(ranking_budgets, dimension);
    $('.ranking-wrapper').find('.sortable').removeClass('active');
    $('.ranking-wrapper').find("[data-dimension='" + dimension + "']").addClass('active');
    plot_ranking();
}
$(document).ready(function(){
    $(document).on('click', '.ranking-wrapper .sortable', function(ev){
        var dimension = $(this).data('dimension');
        sort_ranking(dimension);
    });

    get_ranking(function(data){
        plot_ranking()
    })
});
</script>
{% endblock extrahead %}

{% block content %}
<div class="page-index">
    <div class="hero">
        <div class="container">
            <div class="row">
                <div class="col-6">
                    <h2>
                        Transparência<br>e Tecnologia
                    </h2>
                    <div class="short-description">
                        Conectando a sociedade<br>às finanças públicas
                    </div>
                </div>
                <div class="col-6 img-wrap">
                    <img src="{% static 'img/hero-img.png' %}" />
                </div>
            </div>
        </div>
    </div>
    <div class="about">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2><span class="arrow"></span>Sobre o Projeto</h2>
                </div>
            </div>
            <div class="row">
                <div class="col-4">
                    Esta plataforma torna os orçamentos
                    públicos federais dos PALOP-TL mais
                    acessíveis. Os cidadãos contam agora com
                    uma ferramenta para monitorar as receitas
                    e despesas públicas de forma prática e
                    ágil. Extraímos os dados de relatórios
                    oficiais publicados em formatos fechados
                    e os tornamos estruturados e abertos,
                    prontos para análise. Além das bases,
                    disponibilizamos gráficos interativos
                    e filtros de consulta que facilitam o
                    consumo de informações complexas.
                </div>
                <div class="col-4">
                    Aqui você encontra também o primeiro
                    Índice de Transparência Orçamental com
                    recorte focado nos seis PALOP-TL. Trata-se
                    de um instrumento que pretende dar
                    visibilidade e incentivar avanços no tema.
                    O projeto prevê um crescimento modular
                    tanto da plataforma de dados quanto do
                    índice. Novas perspectivas e abordagens
                    da transparência orçamental serão
                    incorporadas conforme forem definidas
                    em conjunto com representantes da
                    sociedade civil.
                </div>
            </div>
        </div>
    </div>

    <div class="ranking">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="ranking-header">
                        <h2><span class="arrow"></span>RANKING</h2>
                        <h4>Índice PALOP-TL de Transparência Orçamental</h4>
                        <div class="short-description">
                            Resume quantitativamente, em três indicadores, a qualidade da transparência no fornecimento<br>
                            dos dados básicos da receita e despesa que compõem esta plataforma.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-12">Clique no cabeçalho da tabela para ordenar o ranking por uma dimensão específica.</div>
            </div>
        </div>
        <hr />
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="ranking-wrapper">
                        <table class="ranking-table" cellspacing="0" cellpadding="0">
                            <thead>
                                <tr>
                                    <th class="f-position"></th>
                                    <th class="f-flag"></th>
                                    <th></th>
                                    <th class="f-dimension sortable" data-dimension="score_open_data">
                                        Dados Abertos<br>
                                        (0-100)
                                    </th>
                                    <th class="f-dimension sortable" data-dimension="score_reports">
                                        Relatórios Orçamentais<br>
                                        (0-100)
                                    </th>
                                    <th class="f-dimension sortable" data-dimension="score_data_quality">
                                        Qualidade da Informação<br>
                                        (0-300)
                                    </th>
                                    <th class="f-dimension sortable active" data-dimension="transparency_index">
                                        Indicador Geral de Transparência
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="budgets-wrapper"></tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
        <div class="downloads">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <h4>VEJA MAIS DETALHES SOBRE A METODOLOGIA E RESULTADOS DETALHADOS</h4>
                        <ul class="links">
{#                            <li>#}
{#                                Fundamentação do trabalho e Discussão de Resultados do Índice 2020#}
{#                                <a href="#" target="_blank" class="download-link">Download</a>#}
{#                            </li>#}
                            <li>
                                Questionário e Metodologia de Pontuação do Índice de Transparência Orçamental PALOP-TL
                                <a href="{% static 'transparency_index_2020.pdf' %}" target="_blank" class="download-link">Download</a>
                            </li>
                            <li>
                                Resultados Detalhados do Índice PALOP-TL 2020
                                <a href="{% static 'transparency_index_results_2020.pdf' %}" target="_blank" class="download-link">Download</a>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
        <div class="container countries-description">
            <div class="row">
                <div class="col-12">Escolha um país para entender como ele gasta seu orçamento.</div>
            </div>
        </div>
    </div>

    <div class="countries">
        <hr />
        <div class="flags-wrapper">
            <div class="row full-width">
                {% for country in countries %}
                <div class="col">
                    <img src="{{ country.flag.url }}" />
                    <a href="{% url 'country-details' country.slug %}" class="overlay"><span>{{ country.name }}</span></a>
                </div>
                    {% if forloop.counter == 3 %}
                        </div><div class="row full-width">
                    {% endif %}
                {% endfor %}
            </div>
        </div>

    </div>
</div>

{% verbatim %}
<script id="template-ranking" type="text/x-handlebars-template">
{{#each budgets}}
    <tr class="ranking-row row-number-{{inc @index}}">
        <td class="f-position">{{inc @index}}</td>
        <td class="f-flag"><img src="{{ country.flag }}" /></td>
        <td class="f-name">{{ country.name }}</td>
        <td class="f-dimension f-dimension-1">{{ score_open_data }}</td>
        <td class="f-dimension f-dimension-2">{{ score_reports }}</td>
        <td class="f-dimension f-dimension-3">{{ score_data_quality }}</td>
        <td class="f-dimension f-dimension-4">{{ transparency_index }}</td>
    </tr>
    <tr>
        <td colspan="7" class="separator-row"></td>
    </tr>
{{/each}}
<tr class="ranking-row row-number-7 row-avg">
    <td class="f-position"></td>
    <td class="f-flag" colspan="2">Média</td>
    <td class="f-dimension f-dimension-1">{{parseFloat average.score_open_data 2}}</td>
    <td class="f-dimension f-dimension-2">{{parseFloat average.score_reports 2}}</td>
    <td class="f-dimension f-dimension-3">{{parseFloat average.score_data_quality 2}}</td>
    <td class="f-dimension f-dimension-4">{{parseFloat average.transparency_index 2}}</td>
</tr>
</script>
{% endverbatim %}

{% endblock %}