{% extends 'frontend/base.html' %}
{% load static %}

{% block extrahead %}
    <script src="//cdn.amcharts.com/lib/4/core.js"></script>
    <script src="//cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="//cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <script type="text/javascript">

    var treemap;
    var series_templates = [];
    var last_budget_id = {{ last_budget.id }};
    var current_budget_id = last_budget_id;
    var current_budget_account = 'functions';
    var current_budget_account_id = null;
    var current_budget_data = null;
    var breadcrumb = [
        {'name': "Visualização por Função", 'id': null},
        {'name': {{ last_budget.year }}, 'id': null},
    ];
    var budget_account_label_map = {
        'agencies': "Órgão",
        'functions': "Função",
    }
    var sub_budget_account_label_map = {
        'agencies': "Unidade Orçamentária",
        'functions': "Sub-função",
    }
    am4core.useTheme(am4themes_animated);

    function get_budget_data(budget_id, budget_account, callback){
        var url = '/api/budgets/' + budget_id + '/' + budget_account + '/';
        $.get(url, function (data) {
            callback(data);
        }).fail(function () {
            console.log("Error on fetching budget data.");
        }).always(function () {
            //alert("finished");
        });
    }
    function get_historical_data(budget_id, budget_account, budget_account_id, callback){
        var params = {
            budget_account: budget_account,
            budget_account_id: budget_account_id
        }
        var url = '/api/budgets/' + budget_id + '/historical/';
        $.get(url, params, function (data) {
            callback(data);
        }).fail(function () {
            console.log("Error on fetching historical data.");
        }).always(function () {
            //alert("finished");
        });
    }

    function get_budget_account_aggregated_data(budget_data){
        var aggregated_data = $.extend(true, {}, budget_data[0]);
        var fields = ['budget_aggregated', 'budget_investment', 'budget_operation', 'execution_aggregated',
            'execution_investment', 'execution_operation', 'initial_budget_aggregated', 'initial_budget_investment',
            'initial_budget_operation'];
        aggregated_data['label'] = "Orçamento " + get_budget_year_by_id(current_budget_id);
        aggregated_data['name'] = "{{ country.name }}";
        aggregated_data['id'] = null;
        for(var i = 1; i < budget_data.length; i++){
            fields.forEach(function(item, index){
                var new_value = budget_data[i][item];
                if(!new_value){
                    return;
                }
                if(!aggregated_data[item]){
                    aggregated_data[item] = 0
                }
                aggregated_data[item] += new_value;
            });
        }
        return aggregated_data;
    }

    function plot_budget_account_info(data){
        if(data === undefined || !(data)){
            data = get_budget_account_aggregated_data(current_budget_data);
        }
        current_budget_account_id = data['id'];

        //console.log(data);
        var execution_percentage = data['execution_aggregated'] / data['budget_aggregated'];
        var execution_group = 1;
        if(execution_percentage <= 0.2)
            execution_group = 1;
        else if(0.2 < execution_percentage <= 0.4)
            execution_group = 2;
        else if(0.4 < execution_percentage <= 0.6)
            execution_group = 3;
        else if(0.6 < execution_percentage <= 0.8)
            execution_group = 4;
        else if(0.8 < execution_percentage)
            execution_group = 5;
        data['execution_group'] = execution_group;
        data['execution_percentage'] = execution_percentage;

        var source = $('#template-budget_account-info').html();
        var template = Handlebars.compile(source);
        var rendered = template(data);
        $('#budget_account-info').html(rendered);


    }

    function plot_breadcrumb(){
        var source = $('#template-breadcrumb').html();
        var template = Handlebars.compile(source);
        var rendered = template({data: breadcrumb});
        $('.breadcrumb-wrapper').html(rendered);
    }
    function init_breadcrumb(plot=false){
        breadcrumb = []
        breadcrumb.push({name: "Visualização por " + budget_account_label_map[current_budget_account], event: null});
        breadcrumb.push({name: get_budget_year_by_id(current_budget_id), event: null});
        if(plot){
            plot_breadcrumb();
        }
    }
    function update_breadcrumb(event=null){
        if(event){
            var data = event.target.dataItem.dataContext._dataContext;
            if(data['level'] == 0){
                init_breadcrumb();
                breadcrumb.push({name: data['name'], event: event})
            } else {
                breadcrumb[3] = {name: data['name'], event: event};
            }
        }
        plot_breadcrumb();
    }

    function plot_treemap(data){
        treemap = am4core.create("chart-treemap", am4charts.TreeMap);
        treemap.data = current_budget_data;

        /* Define data fields */
        treemap.marginLeft = 0;
        treemap.marginRight = 0;
        treemap.dataFields.value = "budget_aggregated";
        treemap.dataFields.name = "name";
        treemap.dataFields.children = "children";
        treemap.dataFields.color = "color";
        treemap.maxLevels = 1;
        treemap.homeText = "Visualização por " + budget_account_label_map[current_budget_account];
        //treemap.layoutAlgorithm = treemap.slice;

        // Labels & tooltips
        var level_columns = []; var bullets = [];
        function config_label(level){
            series_templates[level] = treemap.seriesTemplates.create(level);
            series_templates[level].columns.template.events.on("hit", function(ev) {
                var data = ev.target.dataItem.dataContext._dataContext;
                plot_budget_account_info(data); // data: api.BudgetAccountSerializer
                get_historical_and_plot_view();
                update_breadcrumb(ev);
            }, this);
            series_templates[level].columns.template.events.on("over", function(ev) {
                var data = ev.target.dataItem.dataContext._dataContext;
                plot_budget_account_info(data);
            }, this);
            series_templates[level].columns.template.events.on("out", function(ev) {
                var parent_data = ev.target.dataItem._dataContext.parent._dataContext;
                //console.log("OUT", parent_data);
                plot_budget_account_info(parent_data);
            }, this);

            // Label
            bullet = series_templates[level].bullets.push(new am4charts.LabelBullet());
            bullet.locationX = 0.02;
            bullet.label.textAlign = 'left';
            bullet.label.dx = 0;
            bullet.label.dy = -10;
            bullet.label.horizontalCenter = 'left';
            bullet.label.verticalCenter = 'middle';
            bullet.label.text = "{name}";
            bullet.label.fill = am4core.color("#ffffff");

            // Tooltip
            level_columns[level] = series_templates[level].columns.template;
            level_columns[level].tooltipText = "{name}\n{value}";
            series_templates[level].tooltip.dy = -15;
            series_templates[level].tooltip.getFillFromObject = false;
            series_templates[level].tooltip.background.propertyFields.stroke = am4core.color("#FFFFFF");
            series_templates[level].tooltip.background.propertyFields.fill = "color";
            series_templates[level].tooltip.pointerOrientation = "vertical";
            series_templates[level].tooltip.label.fill = am4core.color("#FFFFFF");
            series_templates[level].tooltip.label.fontSize = 18;
        }
        config_label('0');
        config_label('1');
        //config_label('2');
    }

    function plot_historical(data){
        var chart = am4core.create('historical-info', am4charts.XYChart)
        chart.colors.step = 2;
        chart.numberFormatter.bigNumberPrefixes = [
            {"number": 1e+3, "suffix": "K"},
            {"number": 1e+6, "suffix": "Mi"},
            {"number": 1e+9, "suffix": "Bi"},
            {"number": 1e+12, "suffix": "Tri"},
            {"number": 1e+15, "suffix": "Qua"}
            /*{"number": 1e+18, "suffix": "E"},
            {"number": 1e+21, "suffix": "Z"},
            {"number": 1e+24, "suffix": "Y"}*/
        ]

        chart.paddingTop = 50;
        chart.legend = new am4charts.Legend();
        chart.legend.position = 'right';
        chart.legend.valign = 'bottom';
        chart.legend.paddingLeft = 150;
        chart.legend.paddingBottom = 30;
        chart.legend.labels.template.maxWidth = 95;
        chart.colors.list = [
            am4core.color("#0f69a3"),
            am4core.color("#98ccda"),
        ];

        var xAxis = chart.xAxes.push(new am4charts.CategoryAxis())
        xAxis.dataFields.category = 'year'
        xAxis.renderer.cellStartLocation = 0.1
        xAxis.renderer.cellEndLocation = 0.9
        xAxis.renderer.grid.template.disabled = true;

        var yAxis = chart.yAxes.push(new am4charts.ValueAxis());
        yAxis.min = 0;
        yAxis.numberFormatter.numberFormat = "#. a";
        yAxis.renderer.grid.template.disabled = true;

        function createSeries(value, name) {
            var series = chart.series.push(new am4charts.ColumnSeries())
            series.dataFields.valueY = value
            series.dataFields.categoryX = 'year'
            series.name = name
            //series.labels.template.wrap = false;

            // Tooltip
            series.columns.template.tooltipText = "[{categoryX}: bold]{valueY.formatNumber('#,###')}[/]";

            // Label
            var bullet = series.bullets.push(new am4charts.LabelBullet())
            bullet.interactionsEnabled = false;
            bullet.dy = -20;
            bullet.fontSize = 12;
            bullet.label.verticalCenter = 'top';
            bullet.label.text = "{valueY.formatNumber('#.# a')}"
            bullet.label.fill = am4core.color('#0f2843');
            //bullet.label.template.wrap = false;

            return series;
        }
        chart.data = data['data'];
        $('.historical-title').html("Despesas discricionárias de<br>" + data['name']);
        createSeries('budget_aggregated', 'Dotação');
        createSeries('execution_aggregated', 'Execução');
    }

    function plot_datatable(data){
        var template_data = {
            'budget_account_label': budget_account_label_map[current_budget_account],
            'sub_budget_account_label': sub_budget_account_label_map[current_budget_account],
            'budget_accounts': data
        }
        var source = $('#template-budget_account-table').html();
        var template = Handlebars.compile(source);
        var rendered = template(template_data);
        //console.log(data);
        $('#datatable-info').html(rendered);
    }

    function init_views(budget_data){
        current_budget_account_id = null;

        plot_treemap(budget_data);
        plot_budget_account_info();
        plot_datatable(budget_data);
        init_breadcrumb(true);
        get_historical_and_plot_view();
    }
    function get_budget_and_plot_views(budget_id, budget_account){
        current_budget_account = budget_account;
        current_budget_id = budget_id;

        get_budget_data(budget_id, budget_account, function(data){
            current_budget_data = data;
            init_views(current_budget_data);
        });
    }
    function get_historical_and_plot_view(){
        get_historical_data(current_budget_id, current_budget_account, current_budget_account_id, function(data){
            plot_historical(data);
        });
    }
    function toggle_budget_account(budget_account){
        get_budget_and_plot_views(current_budget_id, budget_account);
        $('.budget-account-selector a').removeClass('active');
        $('.budget-account-selector a[data-budget_account="'+budget_account+'"]').addClass('active');
    }
    function toggle_budget(budget_id){
        get_budget_and_plot_views(budget_id, current_budget_account);
        $('.budget-selector a').removeClass('active');
        $('.budget-selector a[data-budget_id="'+budget_id+'"]').addClass('active');
    }
    function get_budget_year_by_id(budget_id){
        return $('.budget-selector a[data-budget_id="'+budget_id+'"]').html();
    }

    $(document).ready(function () {
        // Binds
        $('.budget-account-selector a').on('click', function (ev) {
            ev.preventDefault();
            var budget_account = $(this).data('budget_account');
            toggle_budget_account(budget_account);
        });
        $('.budget-selector a').on('click', function (ev) {
            ev.preventDefault();
            var budget_id = $(this).data('budget_id');
            toggle_budget(budget_id);
        });
        $(document).on('click', '.breadcrumb-link', function(ev){
            ev.preventDefault();
            var breadcrumb_index = parseInt($(this).data('breadcrumb_idx'));
            if(breadcrumb_index <= 1){
                init_views(current_budget_data);
            } else {
                breadcrumb[breadcrumb_index].event.target.dispatchImmediately('hit');
            }
        })
        toggle_budget_account(current_budget_account)
    });

    </script>
{% endblock %}

{% block content %}
<div class="page-country-detail">
    {% with bg_name="bg_"|add:country.slug|add:".png" %}
    <div class="country-name-wrapper" style="background-image: url('{% static 'img/'|add:bg_name %}');">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1>{{ country.name }}</h1>
                </div>
            </div>
        </div>
    </div>
    {% endwith %}
    <div class="flag-wrapper">
        <div class="row middle">
            <div class="col-2 mr-0">
                <img class="flag" src="{{ country.flag.url }}" alt="{{ country.slug }} flag" />
            </div>
            <div class="col-10">
                <h3>
                    <span class="arrow-right"></span>
                    DADOS ORÇAMENTÁRIOS
                </h3>
            </div>
        </div>
    </div>

    {% include 'frontend/budget-selector.component.html' %}
    <div class="treemap-wrapper">
        <div class="row">
            <div class="col-3 budget_account-info-wrapper">
                <div id="budget_account-info"></div>
            </div>
            <div class="col-9 chart-wrapper">
                <div id="chart-treemap"></div>
            </div>
        </div>
    </div>

    {% include 'frontend/budget-selector.component.html' %}
    <div class="historical-wrapper">
        <h4 class="historical-title"></h4>
        <div class="container">
            <div class="row">
                <div class="col-10">
                    <div id="historical-info"></div>
                </div>
                <div class="col-2"></div>
            </div>
        </div>
    </div>

    {% include 'frontend/budget-selector.component.html' %}
    <div class="datatable-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div id="datatable-info"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="transparency-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-6">
                    <h2><span class="arrow"></span>TRANSPARÊNCIA</h2>
                    <div>
                        Lorem ipsum dolor sit amet,
                        consectetuer adipiscing elit, sed
                        diam nonummy nibh euismod
                        tincidunt ut la metodologia
                        aliquam erat consequat. Duis vel
                        eum iriure dolor in hendrerit in
                        vulputate velit esse molestie
                        consequat, vel illum dolore eu
                        feugiat nulla facilisis at vero nulla
                        facilisi autem vel eum.
                    </div>
                </div>
                <div class="col-5 img-wrapper">
                    <img src="{% static 'img/transparency.png' %}" alt="Transparency img" />
                </div>
                <div class="col-1">
                </div>
            </div>
        </div>
    </div>

</div>

{% verbatim %}
<script id="template-budget_account-info" type="text/x-handlebars-template">
<div class="budget_account-info">
    <div class="budget_account-info-box">
        <h3>{{ label }}</h3>
        <h4>{{ name }}</h4>
        <div class="aggregated-data">
            <table class="primary-info" cellspacing="0" cellpadding="0">
                <tr>
                    <td>Dotação inicial</td>
                    <td>{{formatCurrency budget_aggregated_initial}}</td>
                </tr>
                <tr>
                    <td>Dotação atualizada</td>
                    <td>{{formatCurrency budget_aggregated }}</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr class="execution-aggregated">
                    <td>Execução</td>
                    <td>
                        {{formatCurrency execution_aggregated }}
                    </td>
                </tr>
            </table>
        </div>
        <div>
            <table class="treemap-legend-table execution-group-{{ execution_group }}">
                <tr class="group-1">
                    <td>20%</td>
                    <td><div class="treemap-legend">&nbsp;</div></td>
                    <td><div class="execution-group-indicator"></div></td>
                    <td><div class="execution-percentage">{{formatPercent execution_percentage}} executado</div></td>
                </tr>
                <tr class="group-2">
                    <td>40%</td>
                    <td><div class="treemap-legend">&nbsp;</div></td>
                    <td><div class="execution-group-indicator"></div></td>
                    <td><div class="execution-percentage">{{formatPercent execution_percentage}} executado</div></td>
                </tr>
                <tr class="group-3">
                    <td>60%</td>
                    <td><div class="treemap-legend">&nbsp;</div></td>
                    <td><div class="execution-group-indicator"></div></td>
                    <td><div class="execution-percentage">{{formatPercent execution_percentage}} executado</div></td>
                </tr>
                <tr class="group-4">
                    <td>80%</td>
                    <td><div class="treemap-legend">&nbsp;</div></td>
                    <td><div class="execution-group-indicator"></div></td>
                    <td><div class="execution-percentage">{{formatPercent execution_percentage}} executado</div></td>
                </tr>
                <tr class="group-5">
                    <td>100%</td>
                    <td><div class="treemap-legend">&nbsp;</div></td>
                    <td><div class="execution-group-indicator"></div></td>
                    <td><div class="execution-percentage">{{formatPercent execution_percentage}} executado</div></td>
                </tr>
            </table>
        </div>
    </div>
    <hr class="mt-0">
    <div class="budget_account-info-box">
        <h4>
            DADOS SECUNDÁRIOS <span class="arrow-down"></span>
        </h4>
    </div>
    <div class="budget_account-info-box">
        <table class="secondary-info">
            <tr>
                <td>{{formatCurrency budget_investment}}</td>
                <td>Dotação atualizada de investimento</td>
            </tr>
            <tr>
                <td>{{formatCurrency budget_operation}}</td>
                <td>Dotação atualizada de funcionamento</td>
            </tr>
            <tr>
                <td>{{formatCurrency execution_investment}}</td>
                <td>Execução de investimento</td>
            </tr>
            <tr>
                <td>{{formatCurrency execution_operation}}</td>
                <td>Execução de funcionamento</td>
            </tr>
        </table>
    </div>
</div>
</script>

<script id="template-budget_account-table" type="text/x-handlebars-template">
<table class="datatable-info" cellpadding="0" cellspacing="0">
    <thead>
        <tr>
            <th>{{ budget_account_label }} / {{ sub_budget_account_label }}</th>
            <th class="vertical-separator"></th>
            <th>Dotação</th>
            <th>Dotação de investimento</th>
            <th>Dotação de funcionamento</th>
            <th>Execução</th>
            <th>Execução de investimento</th>
            <th>Execução de funcionamento</th>
        </tr>
        <tr>
            <td class="separator" colspan="8"></td>
        </tr>
    </thead>
    <tbody>
        {{#each budget_accounts}}
        <tr>
            <td>{{ name }}</td>
            <td class="vertical-separator"></td>
            <td>{{formatCurrency budget_aggregated}}</td>
            <td>{{formatCurrency budget_investment}}</td>
            <td>{{formatCurrency budget_operation}}</td>
            <td>{{formatCurrency execution_aggregated}}</td>
            <td>{{formatCurrency execution_investment}}</td>
            <td>{{formatCurrency execution_operation}}</td>
        </tr>
            {{#each children}}
            <tr>
                <td style="padding-left: 40px;">{{ name }}</td>
                <td class="vertical-separator"></td>
                <td>{{formatCurrency budget_aggregated}}</td>
                <td>{{formatCurrency budget_investment}}</td>
                <td>{{formatCurrency budget_operation}}</td>
                <td>{{formatCurrency execution_aggregated}}</td>
                <td>{{formatCurrency execution_investment}}</td>
                <td>{{formatCurrency execution_operation}}</td>
            </tr>
            {{/each}}
        {{/each}}
    </tbody>
</table>
</script>

<script id="template-breadcrumb" type="text/x-handlebars-template">
{{#each data}}
    <a href="#" class="breadcrumb-link" data-breadcrumb_idx="{{@index}}">{{ name }}</a>
    <span class="arrow-right"></span>
{{/each}}
</script>
{% endverbatim %}



{% endblock %}